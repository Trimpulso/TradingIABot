name: ğŸ” Code Quality & Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  schedule:
    # Cada miÃ©rcoles a las 3 AM UTC
    - cron: '0 3 * * 3'
  workflow_dispatch:

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: ğŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black pylint

      - name: ğŸ¨ Verificar formato
        run: |
          python -c "
          import os
          py_files = []
          for root, dirs, files in os.walk('strategies'):
              for f in files:
                  if f.endswith('.py'):
                      py_files.append(os.path.join(root, f))
          
          if py_files:
              print(f'âœ… Encontrados {len(py_files)} archivos Python')
              for f in py_files:
                  print(f'   - {f}')
          "

      - name: ğŸ“‹ Verificar dependencias
        run: |
          python -c "
          required = ['freqtrade', 'pandas', 'numpy', 'sklearn']
          for pkg in required:
              try:
                  __import__(pkg if pkg != 'sklearn' else 'sklearn')
                  print(f'âœ… {pkg} instalado')
              except ImportError:
                  print(f'âš ï¸ {pkg} no instalado (normal en GitHub Actions)')
          "

      - name: âœ… Validar estructura del proyecto
        run: |
          python -c "
          import os
          
          required_dirs = ['strategies', 'utils', 'config', 'scripts', 'models', 'data', 'notebooks']
          required_files = ['README.md', 'requirements.txt', 'config/config.json']
          
          print('ğŸ“ Verificando directorios...')
          for d in required_dirs:
              if os.path.isdir(d):
                  print(f'âœ… {d}/')
              else:
                  print(f'âš ï¸ {d}/ no encontrado')
          
          print('\nğŸ“„ Verificando archivos...')
          for f in required_files:
              if os.path.isfile(f):
                  print(f'âœ… {f}')
              else:
                  print(f'âš ï¸ {f} no encontrado')
          
          print('\nâœ… Estructura validada')
          "

      - name: ğŸ“Š Reporte de calidad
        run: |
          echo "ğŸ“ˆ Resumen de calidad del cÃ³digo"
          echo "================================"
          echo "âœ… Archivos Python encontrados:"
          find strategies/ utils/ scripts/ -name "*.py" | wc -l
          echo ""
          echo "âœ… LÃ­neas de cÃ³digo:"
          find strategies/ utils/ scripts/ -name "*.py" -exec wc -l {} + | tail -1

      - name: ğŸ’¾ Guardar reporte
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: quality-report
          path: .
          retention-days: 7
