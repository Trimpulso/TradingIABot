name: ğŸ” Code Quality & Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  schedule:
    # Cada miÃ©rcoles a las 3 AM UTC
    - cron: '0 3 * * 3'
  workflow_dispatch:

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: ğŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black pylint

      - name: ğŸ¨ Verificar formato con Black
        run: |
          black --check strategies/ utils/ scripts/ || echo "âš ï¸ Formato no ideal (puedes corregir con: black .)"

      - name: ğŸ” AnÃ¡lisis estÃ¡tico con Flake8
        run: |
          flake8 strategies/ utils/ scripts/ \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            || echo "âš ï¸ Flake8 encontrÃ³ problemas menores"

      - name: ğŸ“‹ Verificar dependencias
        run: |
          pip check || echo "âš ï¸ Algunos paquetes tienen conflictos"

      - name: âœ… Validar archivos de configuraciÃ³n
        run: |
          python -c "
          import json
          try:
              with open('config/config.json', 'r') as f:
                  config = json.load(f)
              print('âœ… config.json vÃ¡lido')
          except Exception as e:
              print(f'âŒ Error en config.json: {e}')
              exit(1)
          "

      - name: ğŸ“Š Reporte de calidad
        run: |
          echo "ğŸ“ˆ Resumen de calidad del cÃ³digo"
          echo "================================"
          echo "âœ… Archivos Python encontrados:"
          find strategies/ utils/ scripts/ -name "*.py" | wc -l
          echo ""
          echo "âœ… LÃ­neas de cÃ³digo:"
          find strategies/ utils/ scripts/ -name "*.py" -exec wc -l {} + | tail -1

      - name: ğŸ’¾ Guardar reporte
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: quality-report
          path: .
          retention-days: 7
